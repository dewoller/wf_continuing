---
title: "Hypothesis 3"
author:  "Mofi Islam and Dennis Wollersheim "
date: "2018-04-30"
output: 
  word_document:
    reference_docx: ../../common/word_reference_style.docx
  html_document:
    code_folding: hide
---


```{r set-options, echo=FALSE, cache=FALSE, warning=FALSE, results='hide'}
rm(list=ls())
library(workflowr)
options(width = 200)
show_code = FALSE
source("lib/functions.R")
source("lib/standardisation.R")
source("lib/get_data.R")
source("lib/generate_data_frames.R")
source("lib/mapping.R")

#df_mapdata = read.csv('data/Data2MapFromMofi.csv') %>% as.tibble()

```
#Methods

```{r data_preparation, echo=FALSE, cache=FALSE, results="hide", warning=FALSE}

data.cache( generate_data_frames, frequency='yearly')

df_population %<>% mutate( seifa=plyr::revalue(seifa, c('Least'='Low'))) 

##################################################################

 printMap = function( df_map, title, filename )  {

  map_color_set_1= RColorBrewer::brewer.pal(6, "Oranges")[2:6]
  map_color_set_2= RColorBrewer::brewer.pal(6, "Blues")[2:6] 

  map_color_set_2= c(RColorBrewer::brewer.pal(5, "PuBuGn") )
  map_color_set_1= c(RColorBrewer::brewer.pal(5, "YlOrRd") )


  pic_width=1500*2
  pic_height=1100*2

  cc_box_width=0.15
  vp_sydney=viewport(x= .50, y= .52, width= cc_box_width, height= cc_box_width)
  vp_melbourne=viewport(x= 0.18, y= 0.18, width= cc_box_width, height= cc_box_width)
  vp_legend=viewport(x= 0.58, y= 0.2, width= 0.3, height= 0.3)
  bbox_oz = c( 140.9617 , -39.15839 , 159.1054 , -28.15702 )

  right_join( df_map, df_population %>% distinct( lga ) ) %>%
    mutate( value = ifelse( is.na(Value), 0, Value )) %>%
    select( lga, value ) %>%
    rbind( data.frame( lga=c(89399), value=0)) %>%
    mutate( value=as.ordered(value)) %>% 
    select( lga, value ) %>%
    append_data( base_map, 
                ., 
                key.shp="LGA_CODE11", 
                key.data="lga" 
                )  %>%
    {.} -> df_map

  df_map %>%
    tm_shape( ) + 
    tm_polygons( "value", 
                title = title,
                palette = map_color_set_1 ,
                showNA=FALSE,
                colorNA='#FFFFFF'
                ) +
tm_layout(frame=FALSE,
          legend.position = c("right", "top"), bg.color="#FFFFFF",
          inner.margins = c(.25,.02,.02,.25),  # how far in from the bottom and right side (for insets)
          legend.show=FALSE) +
tm_shape( capital_city_box(1)) + tm_borders(col="red")+
tm_shape( capital_city_box(2)) + tm_borders(col="red") %>%
{.} -> map

  print(map)

df_map %>%
  tm_shape( ) + 
  tm_polygons( "value", 
              title = title,
              palette = map_color_set_1 ,
              showNA=FALSE,
              colorNA='#FFFFFF'
              ) +
tm_layout(frame=FALSE,
          bg.color="#FFFFFF",
          legend.only=TRUE) %>%
{ . } -> m_legend

  print(m_legend, vp=vp_legend)

df_map %>%
  tm_shape( xlim=get_state_capital_xlim(2),
           ylim=get_state_capital_ylim(2) ) +
tm_polygons( "value", 
            palette = map_color_set_1 ,
            showNA=FALSE,
            colorNA='#FFFFFF',
            legend.show=FALSE) +
tm_layout(frame="red", 
          bg.color="#FFFFFF"
          )  %>%
{.} -> m_melbourne

  df_map %>% 
    tm_shape( xlim=get_state_capital_xlim(1),
             ylim=get_state_capital_ylim(1) ) +
tm_polygons( "value", 
            palette = map_color_set_1 ,
            showNA=FALSE,
            colorNA='#FFFFFF',
            legend.show=FALSE) +
tm_layout(frame="red", bg.color="#FFFFFF")  %>%
{.} -> m_sydney

  # print insets
  print(m_sydney, vp=vp_sydney)
print(m_melbourne, vp=vp_melbourne)
tmap_save( map, 
          insets_vp = list( vp_sydney, vp_melbourne, vp_legend ),
          insets_tm = list( m_sydney, m_melbourne, m_legend ),
          filename=filename, 
          width=pic_width, height=pic_height, asp=0
          ) 
}

##################################################################

require(sp)
#require(rgdal)

capital_city_box = function( state_id ) {
  coords = c( get_state_capital_xlim( state_id ), get_state_capital_ylim( state_id ))
  e <- as(raster::extent(coords), "SpatialPolygons")
  proj4string(e) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
  e
}
##################################################################

title=''
filename='/tmp/map2.png'

##################################################################
printMapVictoria ()

printMapVictoria = function( )  {

  map_color_set_1= RColorBrewer::brewer.pal(6, "Oranges")[2:6]
  map_color_set_2= RColorBrewer::brewer.pal(6, "Blues")[2:6] 


  pic_width=1500*2
  pic_height=1100*2

  cc_box_width=0.15
#  vp_sydney=viewport(x= .50, y= .52, width= cc_box_width, height= cc_box_width)
  vp_melbourne=viewport(x= 0.38, y= 0.18, width= cc_box_width, height= cc_box_width)
  vp_legend=viewport(x= 0.68, y= 0.2, width= 0.3, height= 0.3)
  bbox_oz = c( 140.9617 , -39.15839 , 159.1054 , -28.15702 )


  library( jsonlite)
  library(sf)

  df_hospital = fromJSON('https://www.myhospitals.gov.au/api/hospitals')  %>%
    as.tibble() %>%
    filter( str_to_upper( state ) %in% c('VIC') &
           !isClosed ) %>% 
    mutate( latitude = as.numeric( latitude), longitude = as.numeric( longitude)) %>%
    { . } -> df_hospital
  df_hospital_sf = st_as_sf(df_hospital, coords = c("longitude", "latitude"), 
                            crs = 4326, agr = "constant")


  expand.grid(levels( df_population$seifa ) , levels( df_population$urbanization )) %>%
    mutate( level= paste0( Var2,', ', Var1, ' SEIFA')) %>%
    select( level ) %>% 
    { . } -> my_labels

  df_population %>%
    distinct( lga, seifa, urbanization ) %>%
    filter( startsWith( as.character( lga), '2')) %>%
    mutate( value = as.numeric(seifa) + ( as.numeric(urbanization) - 1) * 4 ) %>%
    select( lga, value )%>%
    mutate( value=ordered(value, labels=my_labels$level )) %>% 
    append_data( base_map %>% filter( STATE_CODE=='2'), 
                ., 
                key.shp="LGA_CODE11", 
                key.data="lga" 
                )  %>%
    {.} -> df_map

  map_color_set_1= RColorBrewer::brewer.pal(5, "Oranges")[2:5]
  map_color_set_2= RColorBrewer::brewer.pal(5, "Blues")[2:5] 


  df_map %>% 
    tm_shape( ) + 
    tm_polygons( "value", 
                palette = c( map_color_set_1 , map_color_set_2),
                showNA=FALSE,
                colorNA='#FFFFFF'
                ) +
    tm_layout(frame=FALSE,
              legend.position = c("right", "top"), bg.color="#FFFFFF",
              inner.margins = c(.25,.02,.02,.25),  # how far in from the bottom and right side (for insets)
              legend.show=FALSE) +
    tm_shape( df_hospital_sf ) + 
    tm_symbols(col = "black", size = .001, shape=4) +
    tm_shape( capital_city_box(2)) + tm_borders(col="red") %>%
    { . } -> map



  print(map)
title=''

df_map %>%
  tm_shape( ) + 
  tm_polygons( "value", 
              title = title,
              palette = c( map_color_set_1 , map_color_set_2),
              showNA=FALSE,
              colorNA='#FFFFFF'
              ) +
tm_layout(frame=FALSE,
          bg.color="#FFFFFF",
          legend.only=TRUE) %>%
{ . } -> m_legend

  print(m_legend, vp=vp_legend)

  df_map %>%
    tm_shape( xlim=get_state_capital_xlim(2),
            ylim=get_state_capital_ylim(2) ) +
    tm_polygons( "value", 
                palette = c( map_color_set_1 , map_color_set_2),
                showNA=FALSE,
                colorNA='#FFFFFF',
                legend.show=FALSE) +
    tm_layout(frame="red", 
              bg.color="#FFFFFF"
              )  +
    tm_shape( df_hospital_sf ) + 
    tm_symbols(col = "black", size = .001, shape=4) %>%
    {.} -> m_melbourne

    # print insets
print(m_melbourne, vp=vp_melbourne)

tmap_save( map, 
          insets_vp = list( vp_melbourne, vp_legend ),
          insets_tm = list( m_melbourne, m_legend ),
          filename=filename, 
          width=pic_width, height=pic_height, asp=0
          ) 

}


require(sp)
#require(rgdal)

capital_city_box = function( state_id ) {
  coords = c( get_state_capital_xlim( state_id ), get_state_capital_ylim( state_id ))
  e <- as(raster::extent(coords), "SpatialPolygons")
  proj4string(e) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
  e
}


```

maps  - now need to generate mapdata

lgas in 4th quartile of dispensing - Figure 3


```{r}

df %>%
  count( type_name, ddd_mg_factor ) 


df_population %>%
  distinct( lga )

df_population %>%
  group_by(supply_year, state) %>%
  summarise( sum( population ))

df %>%
  select_and_standardise_ddd (  standardise_over=qw('lga supply_year')  ) %>%
  group_by( supply_year ) %>%
  mutate( quartile = cut( ddd, quantile( ddd, type=2), labels=1:4 ) )%>%
  ungroup() %>%
  filter( quartile=='4') %>%
  count( lga ) %>% 
  { . } -> df_lgas_in_fourth_quartile

df_lgas_in_fourth_quartile %>%
   count( n ) %>%
   rename( years_in_fourth_quartile = n, count_lga = nn)


 df_population %>%
   distinct( lga,state) %>%
   inner_join( df_lgas_in_fourth_quartile ) %>%
   count( state)

```
lgas in 4th quartile of dispensing  for chronic users - Figure 4

```{r}

df %>%
  inner_join( df_patient_usage ) %>%
  filter( usage_category =='chronic') %>%
  select_and_standardise_ddd (  standardise_over=qw('lga supply_year')  ) %>%
  group_by( supply_year ) %>%
  mutate( quartile = cut( ddd, quantile( ddd, type=2), labels=1:4 ) )%>%
  ungroup() %>%
  filter( quartile=='4') %>%
  count( lga ) %>% 
  { . } -> df_chronic_lgas_in_fourth_quartile

df_chronic_lgas_in_fourth_quartile %>%
  count( n ) %>%
  rename( years_in_fourth_quartile = n, count_lga = nn)


df_population %>%
  distinct( lga,state) %>%
  inner_join( df_chronic_lgas_in_fourth_quartile ) %>%
  count( state)

```

```{r}

df_population %>% 
  distinct( lga, urbanization ) %>%
  append_data( base_map, 
              ., 
              key.shp="LGA_CODE11", 
              key.data="lga" 
              )  %>%
  tm_shape( ) + 
  tm_polygons( "urbanization", 
              ) +
tm_layout(frame=FALSE,
          legend.position = c("right", "top"), bg.color="#FFFFFF",
          inner.margins = c(.25,.02,.02,.25)  )



df_lgas_in_fourth_quartile %>%
  rename( Value = n ) %>%
  printMap( title = "Number of years\nthe regular users\nwere in the\nhighest quartile",
                                                filename = '/tmp/regular.png' )

  df_chronic_lgas_in_fourth_quartile %>%
  rename( Value = n ) %>%
  printMap( title = "Number of years\nthe total quantity\ndispensed to \n chronic users were in\nthe fourth quartile",
           filename = '/tmp/fourthQuartile.png' )



```

#Results for the paper

% for each usage category

```{r}

df_patient_usage %>%
  count( usage_category ) %>%
  mutate( pct = round( n/sum(n) * 100,2 )) %>% 
  kable()

```

```{r}


df_patient %>%
  count( sex ) %>%
  mutate( pct = round( n/sum(n) * 100,2 )) %>% 
  kable()


```
drug type by number of people and drug type 
```{r}

df_patient %>% count() %$% n -> npin


df %>%
  distinct( type_name, pin ) %>%
  count( type_name ) %>%
  mutate( pct = round( n/npin * 100,2 )) %>% 
  kable()


df %>%
  select_and_standardise_ddd (  standardise_over=qw('state type_name') , join_with=qw('supply_year') ) %>%
  count( type_name ) %>%
  mutate( pct = round( n/sum(n) * 100,2 )) %>% 
  kable()
```

DDD/1000 by drug type standardised
```{r}


df %>%
  select_and_standardise_ddd (  standardise_over=qw('state type_name') , join_with=qw('supply_year') ) %>%
  filter( supply_year == '2016') %>%
  select(  -supply_year) %>%
  spread( state, ddd)  %>% 
  kable()


```
mean doses by cateogry
```{r}

df %>%
  inner_join( df_patient_usage ) %>%
  group_by( usage_category ) %>%
  summarise( round( mean( n_dose ), 1 ))  %>% 
  kable()


```
mean doses by seifa
```{r}

df %>%
  inner_join( df_population %>% distinct( lga, seifa )) %>%
  group_by( seifa ) %>%
  summarise( n_dose = round( mean( n_dose ),1) ) %>% 
  kable()


```

#IRR content - TODO

Avg ddd / lga ; and bootstrapped confidence intervals


```{r}
library(rcompanion)
df %>%
  select_and_standardise_ddd (  standardise_over=qw('lga')  ) %>%
  ggplot( aes( ddd, group=1) ) + geom_histogram(bins=60)

df %>%
  select_and_standardise_ddd (  standardise_over=qw('lga')  ) %>%
  groupwiseGeometric( ddd ~ 1, ., conf   = 0.95,
                digits = 6,
                R      = 10000,
                boot        = TRUE,
                traditional = FALSE,
                normal      = FALSE,
                basic       = FALSE,
                percentile  = FALSE,
                bca         = TRUE )

df %>%
  select_and_standardise_ddd (  standardise_over=qw('lga')  ) %$%
  t.test( ddd )

df %>%
  select_and_standardise_ddd (  standardise_over=qw('lga')  ) %>%
  summarise( se = sd( ddd ) / sqrt( length(ddd)))

df %>%
  select_and_standardise_ddd (  standardise_over=qw('lga')  ) %>%
  summarise( mean( ddd ), max(ddd), min(ddd))

```



## Table 2 - Mixed effects model
```{r lme}

library(haven)

library(lme4)

df_population %>%
  distinct( lga, seifa, urbanization ) %>% 
  { . } -> df_lga

df %>%
  distinct( pin, quarter, supply_year) %>%
  count( pin, supply_year  ) %>%
  inner_join( df_patient ) %>% 
  inner_join( df_lga ) %>%
  mutate( supply_year = as.ordered( supply_year )) %>%
  glmer( n~ sex+age+supply_year+seifa+urbanization + (1|state/lga), data=.) %>% 
  { . } -> model

summary(model)
```





## FIgure 2
mean doses by # quarters using
```{r}



df%>%
  inner_join( df_patient_usage ) %>%
  group_by( usage_category, supply_year ) %>%
  summarise( n_dose = round( mean( n_dose ),1) ) %>% 
  ggplot( aes( x=supply_year, y=n_dose, fill=usage_category  ) )+
  geom_col( position='dodge') +
  ylab( "Total quantity (in DDD unit) per prescription" ) + 
  xlab('')



```

##Table 1
ddd / year (standardised) for each year by user_type
```{r}

df %>%
  inner_join( df_patient_usage ) %>%
  select_and_standardise_ddd (  standardise_over=qw('state usage_category supply_year') , join_with=qw('supply_year') ) %>%
  mutate( ddd = round(ddd, 2 ), u_s = paste( usage_category, state)) %>% 
  select(-state, -usage_category) %>%
  group_by( u_s, supply_year ) %>%
  summarise( ddd=sum(ddd))  %>%
  spread( u_s, ddd)  %>% 
  kable()

df %>%
  inner_join( df_patient_usage ) %>%
  select_and_standardise_ddd (  standardise_over=qw('state usage_category') , join_with=qw('supply_year') ) %>%
  mutate( ddd = round(ddd, 2 ), u_s = paste( usage_category, state)) %>% 
  select(-state, -usage_category) %>%
  group_by( u_s ) %>%
  summarise( ddd=sum(ddd))  %>%
  spread( u_s, ddd)  %>% 
  kable()

df %>%
  inner_join( df_patient_usage ) %>%
  select_and_standardise_ddd (  standardise_over=qw('state') , join_with=qw('supply_year') ) %>%
  mutate( ddd = round(ddd, 2 )) %>% 
  spread( state, ddd)  %>% 
  kable()

```

