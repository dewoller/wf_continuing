<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Mofi Islam and Dennis Wollersheim" />

<meta name="date" content="2018-04-30" />

<title>Hypothesis 3</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">wf_continuing</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/jdblischak/workflowr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Hypothesis 3</h1>
<h4 class="author"><em>Mofi Islam and Dennis Wollersheim</em></h4>
<h4 class="date"><em>2018-04-30</em></h4>

</div>


<p><strong>Last updated:</strong> 2018-10-08</p>
<strong>workflowr checks:</strong> <small>(Click a bullet for more information)</small>
<ul>
<li>
<p><details> <summary> <strong style="color:blue;">✔</strong> <strong>R Markdown file:</strong> up-to-date </summary></p>
<p>Great! Since the R Markdown file has been committed to the Git repository, you know the exact version of the code that produced these results.</p>
</details>
</li>
<li>
<p><details> <summary> <strong style="color:blue;">✔</strong> <strong>Environment:</strong> empty </summary></p>
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</details>
</li>
<li>
<p><details> <summary> <strong style="color:blue;">✔</strong> <strong>Seed:</strong> <code>set.seed(20180713)</code> </summary></p>
<p>The command <code>set.seed(20180713)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</details>
</li>
<li>
<p><details> <summary> <strong style="color:blue;">✔</strong> <strong>Session information:</strong> recorded </summary></p>
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</details>
</li>
<li>
<p><details> <summary> <strong style="color:blue;">✔</strong> <strong>Repository version:</strong> <a href="https://github.com/dewoller/wf_continuing/tree/3fa514905e18267596f20255d846e063b7082424" target="_blank">3fa5149</a> </summary></p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility. The version displayed above was the version of the Git repository at the time these results were generated. <br><br> Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
<pre><code>
Ignored files:
    Ignored:    analysis/.Rhistory
    Ignored:    analysis/hypothesis1_cache/
    Ignored:    cache/
    Ignored:    data/

Unstaged changes:
    Modified:   analysis/check2018-1005.Rmd

</code></pre>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes. </details>
</li>
</ul>
<details> <summary> <small><strong>Expand here to see past versions:</strong></small> </summary>
<ul>
<table style="border-collapse:separate; border-spacing:5px;">
<thead>
<tr>
<th style="text-align:left;">
File
</th>
<th style="text-align:left;">
Version
</th>
<th style="text-align:left;">
Author
</th>
<th style="text-align:left;">
Date
</th>
<th style="text-align:left;">
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/dewoller/wf_continuing/blob/3fa514905e18267596f20255d846e063b7082424/analysis/CreateGraphsMofi.Rmd" target="_blank">3fa5149</a>
</td>
<td style="text-align:left;">
Dennis Wollersheim
</td>
<td style="text-align:left;">
2018-10-08
</td>
<td style="text-align:left;">
catchup
</td>
</tr>
<tr>
<td style="text-align:left;">
html
</td>
<td style="text-align:left;">
<a href="https://cdn.rawgit.com/dewoller/wf_continuing/3fa514905e18267596f20255d846e063b7082424/docs/CreateGraphsMofi.html" target="_blank">3fa5149</a>
</td>
<td style="text-align:left;">
Dennis Wollersheim
</td>
<td style="text-align:left;">
2018-10-08
</td>
<td style="text-align:left;">
catchup
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/dewoller/wf_continuing/blob/7a65b24a4cb29b414f16ad9804a53d6c8d7225be/analysis/CreateGraphsMofi.Rmd" target="_blank">7a65b24</a>
</td>
<td style="text-align:left;">
Dennis Wollersheim
</td>
<td style="text-align:left;">
2018-09-11
</td>
<td style="text-align:left;">
mofis special graphs part 2, working
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/dewoller/wf_continuing/blob/3b7b18ebdff991c738173dc9a4fd44a44cbaf41a/analysis/CreateGraphsMofi.Rmd" target="_blank">3b7b18e</a>
</td>
<td style="text-align:left;">
Dennis Wollersheim
</td>
<td style="text-align:left;">
2018-09-10
</td>
<td style="text-align:left;">
first commit
</td>
</tr>
</tbody>
</table>
</ul>
<p></details></p>
<hr />
<pre><code>This is workflowr version 1.1.1
Run ?workflowr for help getting started</code></pre>
<pre><code>Loading required package: wrapr</code></pre>
<pre><code>Loading required package: data.table</code></pre>
<pre><code>
Attaching package: &#39;data.table&#39;</code></pre>
<pre><code>The following object is masked from &#39;package:wrapr&#39;:

    :=</code></pre>
<pre><code>Loading required package: seas</code></pre>
<pre><code>Loading required package: MASS</code></pre>
<pre><code>Loading required package: magrittr</code></pre>
<pre><code>Loading required package: stringr</code></pre>
<pre><code>Loading required package: broom</code></pre>
<pre><code>Loading required package: knitr</code></pre>
<pre><code>Loading required package: kableExtra</code></pre>
<pre><code>Loading required package: pander</code></pre>
<pre><code>Loading required package: lubridate</code></pre>
<pre><code>
Attaching package: &#39;lubridate&#39;</code></pre>
<pre><code>The following objects are masked from &#39;package:data.table&#39;:

    hour, isoweek, mday, minute, month, quarter, second, wday, week, yday, year</code></pre>
<pre><code>The following object is masked from &#39;package:base&#39;:

    date</code></pre>
<pre><code>Loading required package: tmap</code></pre>
<pre><code>Loading required package: tmaptools</code></pre>
<pre><code>Loading required package: grid</code></pre>
<pre><code>Loading required package: readstata13</code></pre>
<pre><code>Loading required package: foreign</code></pre>
<pre><code>Loading required package: ordinal</code></pre>
<pre><code>Loading required package: DataCache</code></pre>
<pre><code>
Attaching package: &#39;DataCache&#39;</code></pre>
<pre><code>The following object is masked from &#39;package:lubridate&#39;:

    now</code></pre>
<pre><code>Loading required package: shiny</code></pre>
<pre><code>
Attaching package: &#39;shiny&#39;</code></pre>
<pre><code>The following object is masked from &#39;package:pander&#39;:

    p</code></pre>
<pre><code>Loading required package: tidyverse</code></pre>
<pre><code>── Attaching packages ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>✔ ggplot2 2.2.1     ✔ readr   1.1.1
✔ tibble  1.4.2     ✔ purrr   0.2.5
✔ tidyr   0.8.1     ✔ dplyr   0.7.6
✔ ggplot2 2.2.1     ✔ forcats 0.3.0</code></pre>
<pre><code>── Conflicts ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
✖ lubridate::as.difftime() masks base::as.difftime()
✖ dplyr::between()         masks data.table::between()
✖ dplyr::coalesce()        masks wrapr::coalesce()
✖ lubridate::date()        masks base::date()
✖ tidyr::extract()         masks magrittr::extract()
✖ dplyr::filter()          masks stats::filter()
✖ dplyr::first()           masks data.table::first()
✖ lubridate::hour()        masks data.table::hour()
✖ lubridate::intersect()   masks base::intersect()
✖ lubridate::isoweek()     masks data.table::isoweek()
✖ dplyr::lag()             masks stats::lag()
✖ dplyr::last()            masks data.table::last()
✖ lubridate::mday()        masks data.table::mday()
✖ lubridate::minute()      masks data.table::minute()
✖ lubridate::month()       masks data.table::month()
✖ DataCache::now()         masks lubridate::now()
✖ lubridate::quarter()     masks data.table::quarter()
✖ lubridate::second()      masks data.table::second()
✖ dplyr::select()          masks MASS::select()
✖ purrr::set_names()       masks magrittr::set_names()
✖ lubridate::setdiff()     masks base::setdiff()
✖ dplyr::slice()           masks ordinal::slice()
✖ purrr::transpose()       masks data.table::transpose()
✖ lubridate::union()       masks base::union()
✖ lubridate::wday()        masks data.table::wday()
✖ lubridate::week()        masks data.table::week()
✖ lubridate::yday()        masks data.table::yday()
✖ lubridate::year()        masks data.table::year()</code></pre>
<pre><code>Loading required package: RPostgreSQL</code></pre>
<pre><code>Loading required package: DBI</code></pre>
<pre><code>Loading required package: keyring</code></pre>
<div id="methods" class="section level1">
<h1>Methods</h1>
<pre><code>Loading more recent data, returning lastest available.</code></pre>
<pre><code>Loading required package: sp</code></pre>
<p>maps - now need to generate mapdata</p>
<p>lgas in 4th quartile of dispensing - Figure 3</p>
<pre class="r"><code>df %&gt;%
  count( type_name, ddd_mg_factor ) </code></pre>
<pre><code># A tibble: 13 x 3
   type_name               ddd_mg_factor       n
   &lt;chr&gt;                           &lt;dbl&gt;   &lt;int&gt;
 1 Bupre                             1.2  305053
 2 Fentanyl                          0.6     786
 3 Fentanyl                          1.2  137808
 4 Hydromorphone                     4      3234
 5 Hydromorphone                    20     30253
 6 Methadone                        25     14316
 7 Morphine                         30     24248
 8 Morphine                        100     92753
 9 Oxycodone and Oxy+Nalox          30       807
10 Oxycodone and Oxy+Nalox          75   1143715
11 Para_Codeine                    100    758182
12 Tapentadol                      400     35348
13 Tramadol                        300    477753</code></pre>
<pre class="r"><code>df_population %&gt;%
  distinct( lga )</code></pre>
<pre><code># A tibble: 235 x 1
   lga  
   &lt;fct&gt;
 1 10050
 2 10110
 3 10150
 4 10200
 5 10250
 6 10300
 7 10350
 8 10470
 9 10550
10 10600
# ... with 225 more rows</code></pre>
<pre class="r"><code>df_population %&gt;%
  group_by(supply_year, state) %&gt;%
  summarise( sum( population ))</code></pre>
<pre><code># A tibble: 10 x 3
# Groups:   supply_year [?]
   supply_year state `sum(population)`
   &lt;fct&gt;       &lt;chr&gt;             &lt;dbl&gt;
 1 2012        NSW             7307183
 2 2012        VIC             5653429
 3 2013        NSW             7407063
 4 2013        VIC             5775808
 5 2014        NSW             7513418
 6 2014        VIC             5901970
 7 2015        NSW             7617684
 8 2015        VIC             6032968
 9 2016        NSW             7720791
10 2016        VIC             6179249</code></pre>
<pre class="r"><code>df %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;lga supply_year&#39;)  ) %&gt;%
  group_by( supply_year ) %&gt;%
  mutate( quartile = cut( ddd, quantile( ddd), labels=1:4 ) )%&gt;%
  ungroup() %&gt;%
  filter( quartile==&#39;4&#39;) %&gt;%
  count( lga ) %&gt;% 
  { . } -&gt; df_lgas_in_fourth_quartile</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre class="r"><code>df_lgas_in_fourth_quartile %&gt;%
   count( n ) %&gt;%
   rename( years_in_fourth_quartile = n, count_lga = nn)</code></pre>
<pre><code># A tibble: 4 x 2
  years_in_fourth_quartile count_lga
                     &lt;int&gt;     &lt;int&gt;
1                        1        11
2                        2        10
3                        3        11
4                        4        42</code></pre>
<pre class="r"><code> df_population %&gt;%
   distinct( lga,state) %&gt;%
   inner_join( df_lgas_in_fourth_quartile ) %&gt;%
   count( state)</code></pre>
<pre><code>Joining, by = &quot;lga&quot;</code></pre>
<pre><code>Warning: Column `lga` joining factor and character vector, coercing into character vector</code></pre>
<pre><code># A tibble: 2 x 2
  state    nn
  &lt;chr&gt; &lt;int&gt;
1 NSW      54
2 VIC      20</code></pre>
<p>lgas in 4th quartile of dispensing for chronic users - Figure 4</p>
<pre class="r"><code>df %&gt;%
  inner_join( df_patient_usage ) %&gt;%
  filter( usage_category ==&#39;chronic&#39;) %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;lga supply_year&#39;)  ) %&gt;%
  group_by( supply_year ) %&gt;%
  mutate( quartile = cut( ddd, quantile( ddd), labels=1:4 ) )%&gt;%
  ungroup() %&gt;%
  filter( quartile==&#39;4&#39;) %&gt;%
  count( lga ) %&gt;% 
  { . } -&gt; df_chronic_lgas_in_fourth_quartile</code></pre>
<pre><code>Joining, by = &quot;pin&quot;</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre class="r"><code>df_chronic_lgas_in_fourth_quartile %&gt;%
  count( n ) %&gt;%
  rename( years_in_fourth_quartile = n, count_lga = nn)</code></pre>
<pre><code># A tibble: 4 x 2
  years_in_fourth_quartile count_lga
                     &lt;int&gt;     &lt;int&gt;
1                        1         9
2                        2        10
3                        3         9
4                        4        44</code></pre>
<pre class="r"><code>df_population %&gt;%
  distinct( lga,state) %&gt;%
  inner_join( df_chronic_lgas_in_fourth_quartile ) %&gt;%
  count( state)</code></pre>
<pre><code>Joining, by = &quot;lga&quot;</code></pre>
<pre><code>Warning: Column `lga` joining factor and character vector, coercing into character vector</code></pre>
<pre><code># A tibble: 2 x 2
  state    nn
  &lt;chr&gt; &lt;int&gt;
1 NSW      50
2 VIC      22</code></pre>
<pre class="r"><code>library( jsonlite)</code></pre>
<pre><code>
Attaching package: &#39;jsonlite&#39;</code></pre>
<pre><code>The following object is masked from &#39;package:purrr&#39;:

    flatten</code></pre>
<pre><code>The following object is masked from &#39;package:shiny&#39;:

    validate</code></pre>
<pre class="r"><code>library(sf)</code></pre>
<pre><code>Linking to GEOS 3.5.1, GDAL 2.2.1, proj.4 4.9.3</code></pre>
<pre class="r"><code>df_hospital = fromJSON(&#39;https://www.myhospitals.gov.au/api/hospitals&#39;)  %&gt;%
  as.tibble()

df_hospital %&gt;%
  filter( str_to_upper( state ) %in% c(&#39;NSW&#39;,&#39;VIC&#39;) &amp;
         !isClosed ) %&gt;% 
  mutate( latitude = as.numeric( latitude), longitude = as.numeric( longitude)) %&gt;%
  { . } -&gt; df_hospital

df_hospital_sf = st_as_sf(df_hospital, coords = c(&quot;longitude&quot;, &quot;latitude&quot;), 
                 crs = 4326, agr = &quot;constant&quot;)

df_chronic_lgas_in_fourth_quartile  %&gt;%
  inner_join( df_population %&gt;% distinct( lga, urbanization )) %&gt;%
  mutate( value = ifelse( is.na(n), 0, n )) %&gt;%
  select( lga, value, urbanization ) %&gt;%
  rbind( data.frame( lga=c(89399), value=0, urbanization=&#39;Urban&#39;)) %&gt;%
  mutate( value=as.ordered(value)) %&gt;% 
  select( lga, value, urbanization ) %&gt;%
  append_data( base_map, 
              ., 
              key.shp=&quot;LGA_CODE11&quot;, 
              key.data=&quot;lga&quot; 
              )  %&gt;%
  {.} -&gt; df_map</code></pre>
<pre><code>Joining, by = &quot;lga&quot;</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Under coverage: 161 out of 234 shape features did not get appended data. Run under_coverage() to get the corresponding feature id numbers and key values.</code></pre>
<pre class="r"><code>map_color_set_1= RColorBrewer::brewer.pal(6, &quot;Oranges&quot;)[2:6]
map_color_set_2= RColorBrewer::brewer.pal(6, &quot;Blues&quot;)[2:6] 


df_map %&gt;% 
  mutate( value=as.numeric( value), 
         value = as.ordered( ifelse( urbanization == &#39;Urban&#39;, value+5,value))) %&gt;%
  tm_shape( ) + 
  tm_polygons( &quot;value&quot;, 
              palette = c( map_color_set_1 , map_color_set_2),
              showNA=FALSE,
              colorNA=&#39;#FFFFFF&#39;
              ) +
tm_layout(frame=FALSE,
          legend.position = c(&quot;right&quot;, &quot;top&quot;), bg.color=&quot;#FFFFFF&quot;,
          inner.margins = c(.25,.02,.02,.25),  # how far in from the bottom and right side (for insets)
          legend.show=FALSE) +
tm_shape( df_hospital_sf ) + 
tm_symbols(col = &quot;black&quot;, size = .001, shape=4) </code></pre>
<p><img src="figure/CreateGraphsMofi.Rmd/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;" /></p>
<details> <summary><em>Expand here to see past versions of unnamed-chunk-3-1.png:</em></summary>
<table style="border-collapse:separate; border-spacing:5px;">
<thead>
<tr>
<th style="text-align:left;">
Version
</th>
<th style="text-align:left;">
Author
</th>
<th style="text-align:left;">
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<a href="https://github.com/dewoller/wf_continuing/blob/3fa514905e18267596f20255d846e063b7082424/docs/figure/CreateGraphsMofi.Rmd/unnamed-chunk-3-1.png" target="_blank">3fa5149</a>
</td>
<td style="text-align:left;">
Dennis Wollersheim
</td>
<td style="text-align:left;">
2018-10-08
</td>
</tr>
</tbody>
</table>
<p></details></p>
<pre class="r"><code>df_population %&gt;% 
  distinct( lga, urbanization ) %&gt;%
  append_data( base_map, 
              ., 
              key.shp=&quot;LGA_CODE11&quot;, 
              key.data=&quot;lga&quot; 
              )  %&gt;%
  tm_shape( ) + 
  tm_polygons( &quot;urbanization&quot;, 
              ) +
tm_layout(frame=FALSE,
          legend.position = c(&quot;right&quot;, &quot;top&quot;), bg.color=&quot;#FFFFFF&quot;,
          inner.margins = c(.25,.02,.02,.25)  )</code></pre>
<pre><code>Under coverage: 1 out of 234 shape features did not get appended data. Run under_coverage() to get the corresponding feature id numbers and key values.</code></pre>
<pre><code>Over coverage: 2 out of 235 data records were not appended. Run over_coverage() to get the corresponding data row numbers and key values.</code></pre>
<p><img src="figure/CreateGraphsMofi.Rmd/unnamed-chunk-3-2.png" width="672" style="display: block; margin: auto;" /></p>
<details> <summary><em>Expand here to see past versions of unnamed-chunk-3-2.png:</em></summary>
<table style="border-collapse:separate; border-spacing:5px;">
<thead>
<tr>
<th style="text-align:left;">
Version
</th>
<th style="text-align:left;">
Author
</th>
<th style="text-align:left;">
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<a href="https://github.com/dewoller/wf_continuing/blob/3fa514905e18267596f20255d846e063b7082424/docs/figure/CreateGraphsMofi.Rmd/unnamed-chunk-3-2.png" target="_blank">3fa5149</a>
</td>
<td style="text-align:left;">
Dennis Wollersheim
</td>
<td style="text-align:left;">
2018-10-08
</td>
</tr>
</tbody>
</table>
<p></details></p>
<pre class="r"><code>df_lgas_in_fourth_quartile %&gt;%
  rename( Value = n ) %&gt;%
  printMap( title = &quot;Number of years\nthe regular users\nwere in the\nhighest quartile&quot;,
                                                filename = &#39;/tmp/regular.png&#39; )</code></pre>
<pre><code>Joining, by = &quot;lga&quot;</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Over coverage: 2 out of 236 data records were not appended. Run over_coverage() to get the corresponding data row numbers and key values.</code></pre>
<pre><code>Map saved to /tmp/regular.png</code></pre>
<pre><code>Resolution: 3000 by 2200 pixels</code></pre>
<pre><code>Size: 10 by 7.333333 inches (300 dpi)</code></pre>
<p><img src="figure/CreateGraphsMofi.Rmd/unnamed-chunk-3-3.png" width="672" style="display: block; margin: auto;" /></p>
<details> <summary><em>Expand here to see past versions of unnamed-chunk-3-3.png:</em></summary>
<table style="border-collapse:separate; border-spacing:5px;">
<thead>
<tr>
<th style="text-align:left;">
Version
</th>
<th style="text-align:left;">
Author
</th>
<th style="text-align:left;">
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<a href="https://github.com/dewoller/wf_continuing/blob/3fa514905e18267596f20255d846e063b7082424/docs/figure/CreateGraphsMofi.Rmd/unnamed-chunk-3-3.png" target="_blank">3fa5149</a>
</td>
<td style="text-align:left;">
Dennis Wollersheim
</td>
<td style="text-align:left;">
2018-10-08
</td>
</tr>
</tbody>
</table>
<p></details></p>
<pre class="r"><code>  df_chronic_lgas_in_fourth_quartile %&gt;%
  rename( Value = n ) %&gt;%
  printMap( title = &quot;Number of years\nthe total quantity\ndispensed to \n chronic users were in\nthe fourth quartile&quot;,
           filename = &#39;/tmp/fourthQuartile.png&#39; )</code></pre>
<pre><code>Joining, by = &quot;lga&quot;</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Over coverage: 2 out of 236 data records were not appended. Run over_coverage() to get the corresponding data row numbers and key values.</code></pre>
<pre><code>Map saved to /tmp/fourthQuartile.png</code></pre>
<pre><code>Resolution: 3000 by 2200 pixels</code></pre>
<pre><code>Size: 10 by 7.333333 inches (300 dpi)</code></pre>
<p><img src="figure/CreateGraphsMofi.Rmd/unnamed-chunk-3-4.png" width="672" style="display: block; margin: auto;" /></p>
<details> <summary><em>Expand here to see past versions of unnamed-chunk-3-4.png:</em></summary>
<table style="border-collapse:separate; border-spacing:5px;">
<thead>
<tr>
<th style="text-align:left;">
Version
</th>
<th style="text-align:left;">
Author
</th>
<th style="text-align:left;">
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<a href="https://github.com/dewoller/wf_continuing/blob/3fa514905e18267596f20255d846e063b7082424/docs/figure/CreateGraphsMofi.Rmd/unnamed-chunk-3-4.png" target="_blank">3fa5149</a>
</td>
<td style="text-align:left;">
Dennis Wollersheim
</td>
<td style="text-align:left;">
2018-10-08
</td>
</tr>
</tbody>
</table>
<p></details></p>
</div>
<div id="results-for-the-paper" class="section level1">
<h1>Results for the paper</h1>
<p>% for each usage category</p>
<pre class="r"><code>df_patient_usage %&gt;%
  count( usage_category ) %&gt;%
  mutate( pct = round( n/sum(n) * 100,2 )) %&gt;% 
  kable()</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
usage_category
</th>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
pct
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
one-off
</td>
<td style="text-align:right;">
197775
</td>
<td style="text-align:right;">
52.69
</td>
</tr>
<tr>
<td style="text-align:left;">
medium-episodic
</td>
<td style="text-align:right;">
140084
</td>
<td style="text-align:right;">
37.32
</td>
</tr>
<tr>
<td style="text-align:left;">
long-episodic
</td>
<td style="text-align:right;">
18713
</td>
<td style="text-align:right;">
4.99
</td>
</tr>
<tr>
<td style="text-align:left;">
chronic
</td>
<td style="text-align:right;">
18792
</td>
<td style="text-align:right;">
5.01
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>df_patient %&gt;%
  count( sex ) %&gt;%
  mutate( pct = round( n/sum(n) * 100,2 )) %&gt;% 
  kable()</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
sex
</th>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
pct
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
F
</td>
<td style="text-align:right;">
200875
</td>
<td style="text-align:right;">
53.51
</td>
</tr>
<tr>
<td style="text-align:left;">
M
</td>
<td style="text-align:right;">
174489
</td>
<td style="text-align:right;">
46.49
</td>
</tr>
</tbody>
</table>
<p>drug type by number of people and drug type</p>
<pre class="r"><code>df %&gt;%
  distinct( type_name, pin ) %&gt;%
  count( type_name ) %&gt;%
  mutate( pct = round( n/sum(n) * 100,2 )) %&gt;% 
  kable()</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
type_name
</th>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
pct
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Bupre
</td>
<td style="text-align:right;">
23086
</td>
<td style="text-align:right;">
4.16
</td>
</tr>
<tr>
<td style="text-align:left;">
Fentanyl
</td>
<td style="text-align:right;">
9546
</td>
<td style="text-align:right;">
1.72
</td>
</tr>
<tr>
<td style="text-align:left;">
Hydromorphone
</td>
<td style="text-align:right;">
3084
</td>
<td style="text-align:right;">
0.56
</td>
</tr>
<tr>
<td style="text-align:left;">
Methadone
</td>
<td style="text-align:right;">
769
</td>
<td style="text-align:right;">
0.14
</td>
</tr>
<tr>
<td style="text-align:left;">
Morphine
</td>
<td style="text-align:right;">
15221
</td>
<td style="text-align:right;">
2.75
</td>
</tr>
<tr>
<td style="text-align:left;">
Oxycodone and Oxy+Nalox
</td>
<td style="text-align:right;">
173730
</td>
<td style="text-align:right;">
31.33
</td>
</tr>
<tr>
<td style="text-align:left;">
Para_Codeine
</td>
<td style="text-align:right;">
249938
</td>
<td style="text-align:right;">
45.08
</td>
</tr>
<tr>
<td style="text-align:left;">
Tapentadol
</td>
<td style="text-align:right;">
6666
</td>
<td style="text-align:right;">
1.20
</td>
</tr>
<tr>
<td style="text-align:left;">
Tramadol
</td>
<td style="text-align:right;">
72451
</td>
<td style="text-align:right;">
13.07
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>df %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;state type_name&#39;) , join_with=qw(&#39;supply_year&#39;) ) %&gt;%
  count( type_name ) %&gt;%
  mutate( pct = round( n/sum(n) * 100,2 )) %&gt;% 
  kable()</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining character vector and factor, coercing into character vector

Warning: Column `supply_year` joining character vector and factor, coercing into character vector</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
type_name
</th>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
pct
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Bupre
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
11.43
</td>
</tr>
<tr>
<td style="text-align:left;">
Fentanyl
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
11.43
</td>
</tr>
<tr>
<td style="text-align:left;">
Hydromorphone
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
11.43
</td>
</tr>
<tr>
<td style="text-align:left;">
Methadone
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
11.43
</td>
</tr>
<tr>
<td style="text-align:left;">
Morphine
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
11.43
</td>
</tr>
<tr>
<td style="text-align:left;">
Oxycodone and Oxy+Nalox
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
11.43
</td>
</tr>
<tr>
<td style="text-align:left;">
Para_Codeine
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
11.43
</td>
</tr>
<tr>
<td style="text-align:left;">
Tapentadol
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
8.57
</td>
</tr>
<tr>
<td style="text-align:left;">
Tramadol
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
11.43
</td>
</tr>
</tbody>
</table>
<p>DDD/1000 by drug type standardised</p>
<pre class="r"><code>df %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;state type_name&#39;) , join_with=qw(&#39;supply_year&#39;) ) %&gt;%
  filter( supply_year == &#39;2016&#39;) %&gt;%
  select(  -supply_year) %&gt;%
  spread( state, ddd)  %&gt;% 
  kable()</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining character vector and factor, coercing into character vector

Warning: Column `supply_year` joining character vector and factor, coercing into character vector</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
type_name
</th>
<th style="text-align:right;">
NSW
</th>
<th style="text-align:right;">
VIC
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Bupre
</td>
<td style="text-align:right;">
0.5817052
</td>
<td style="text-align:right;">
0.7340719
</td>
</tr>
<tr>
<td style="text-align:left;">
Fentanyl
</td>
<td style="text-align:right;">
1.1774106
</td>
<td style="text-align:right;">
0.8062729
</td>
</tr>
<tr>
<td style="text-align:left;">
Hydromorphone
</td>
<td style="text-align:right;">
0.3447852
</td>
<td style="text-align:right;">
0.4179510
</td>
</tr>
<tr>
<td style="text-align:left;">
Methadone
</td>
<td style="text-align:right;">
0.2398462
</td>
<td style="text-align:right;">
0.2087138
</td>
</tr>
<tr>
<td style="text-align:left;">
Morphine
</td>
<td style="text-align:right;">
0.6577799
</td>
<td style="text-align:right;">
0.7745479
</td>
</tr>
<tr>
<td style="text-align:left;">
Oxycodone and Oxy+Nalox
</td>
<td style="text-align:right;">
3.4783417
</td>
<td style="text-align:right;">
3.0766922
</td>
</tr>
<tr>
<td style="text-align:left;">
Para_Codeine
</td>
<td style="text-align:right;">
5.0913249
</td>
<td style="text-align:right;">
5.2511292
</td>
</tr>
<tr>
<td style="text-align:left;">
Tapentadol
</td>
<td style="text-align:right;">
0.3816841
</td>
<td style="text-align:right;">
0.4072286
</td>
</tr>
<tr>
<td style="text-align:left;">
Tramadol
</td>
<td style="text-align:right;">
2.3613040
</td>
<td style="text-align:right;">
2.6143756
</td>
</tr>
</tbody>
</table>
<p>mean doses by cateogry</p>
<pre class="r"><code>df %&gt;%
  inner_join( df_patient_usage ) %&gt;%
  group_by( usage_category ) %&gt;%
  summarise( round( mean( n_dose ), 1 ))  %&gt;% 
  kable()</code></pre>
<pre><code>Joining, by = &quot;pin&quot;</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
usage_category
</th>
<th style="text-align:right;">
round(mean(n_dose), 1)
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
one-off
</td>
<td style="text-align:right;">
4.5
</td>
</tr>
<tr>
<td style="text-align:left;">
medium-episodic
</td>
<td style="text-align:right;">
5.6
</td>
</tr>
<tr>
<td style="text-align:left;">
long-episodic
</td>
<td style="text-align:right;">
8.3
</td>
</tr>
<tr>
<td style="text-align:left;">
chronic
</td>
<td style="text-align:right;">
13.5
</td>
</tr>
</tbody>
</table>
<p>mean doses by seifa</p>
<pre class="r"><code>df %&gt;%
  inner_join( df_population %&gt;% distinct( lga, seifa )) %&gt;%
  group_by( seifa ) %&gt;%
  summarise( n_dose = round( mean( n_dose ),1) ) %&gt;% 
  kable()</code></pre>
<pre><code>Joining, by = &quot;lga&quot;</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
seifa
</th>
<th style="text-align:right;">
n_dose
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Least
</td>
<td style="text-align:right;">
10.5
</td>
</tr>
<tr>
<td style="text-align:left;">
Moderate
</td>
<td style="text-align:right;">
10.3
</td>
</tr>
<tr>
<td style="text-align:left;">
High
</td>
<td style="text-align:right;">
10.3
</td>
</tr>
<tr>
<td style="text-align:left;">
Very High
</td>
<td style="text-align:right;">
8.4
</td>
</tr>
<tr>
<td style="text-align:left;">
NA
</td>
<td style="text-align:right;">
3.9
</td>
</tr>
</tbody>
</table>
</div>
<div id="irr-content---todo" class="section level1">
<h1>IRR content - TODO</h1>
<p>Avg ddd / lga ; and bootstrapped confidence intervals</p>
<pre class="r"><code>library(rcompanion)
df %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;lga&#39;)  ) %&gt;%
  ggplot( aes( ddd, group=1) ) + geom_histogram(bins=60)</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<p><img src="figure/CreateGraphsMofi.Rmd/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<details> <summary><em>Expand here to see past versions of unnamed-chunk-10-1.png:</em></summary>
<table style="border-collapse:separate; border-spacing:5px;">
<thead>
<tr>
<th style="text-align:left;">
Version
</th>
<th style="text-align:left;">
Author
</th>
<th style="text-align:left;">
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<a href="https://github.com/dewoller/wf_continuing/blob/3fa514905e18267596f20255d846e063b7082424/docs/figure/CreateGraphsMofi.Rmd/unnamed-chunk-10-1.png" target="_blank">3fa5149</a>
</td>
<td style="text-align:left;">
Dennis Wollersheim
</td>
<td style="text-align:left;">
2018-10-08
</td>
</tr>
</tbody>
</table>
<p></details></p>
<pre class="r"><code>df %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;lga&#39;)  ) %&gt;%
  groupwiseGeometric( ddd ~ 1, ., conf   = 0.95,
                digits = 6,
                R      = 10000,
                boot        = TRUE,
                traditional = FALSE,
                normal      = FALSE,
                basic       = FALSE,
                percentile  = FALSE,
                bca         = TRUE )</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector

Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>   .id   n Geo.mean sd.lower sd.upper se.lower se.upper ci.lower ci.upper
1 &lt;NA&gt; 232  16.2173  9.02361  29.1457  15.6049  16.8536  15.0329  17.4949</code></pre>
<pre class="r"><code>df %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;lga&#39;)  ) %$%
  t.test( ddd )</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector

Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>
    One Sample t-test

data:  ddd
t = 30.398, df = 231, p-value &lt; 2.2e-16
alternative hypothesis: true mean is not equal to 0
95 percent confidence interval:
 17.55011 19.98287
sample estimates:
mean of x 
 18.76649 </code></pre>
<pre class="r"><code>df %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;lga&#39;)  ) %&gt;%
  summarise( se = sd( ddd ) / sqrt( length(ddd)))</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector

Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code># A tibble: 1 x 1
     se
  &lt;dbl&gt;
1 0.617</code></pre>
<pre class="r"><code>df %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;lga&#39;)  ) %&gt;%
  summarise( mean( ddd ), max(ddd), min(ddd))</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector

Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code># A tibble: 1 x 3
  `mean(ddd)` `max(ddd)` `min(ddd)`
        &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
1        18.8       66.2       1.20</code></pre>
<div id="table-2---mixed-effects-model" class="section level2">
<h2>Table 2 - Mixed effects model</h2>
<pre class="r"><code>library(haven)

library(lme4)</code></pre>
<pre><code>Loading required package: Matrix</code></pre>
<pre><code>
Attaching package: &#39;Matrix&#39;</code></pre>
<pre><code>The following object is masked from &#39;package:tidyr&#39;:

    expand</code></pre>
<pre><code>
Attaching package: &#39;lme4&#39;</code></pre>
<pre><code>The following objects are masked from &#39;package:ordinal&#39;:

    ranef, VarCorr</code></pre>
<pre class="r"><code>df_population %&gt;%
  distinct( lga, seifa, urbanization ) %&gt;% 
  { . } -&gt; df_lga

df %&gt;%
  distinct( pin, quarter, supply_year) %&gt;%
  count( pin, supply_year  ) %&gt;%
  inner_join( df_patient ) %&gt;% 
  inner_join( df_lga ) %&gt;%
  mutate( supply_year = as.ordered( supply_year )) %&gt;%
  glmer( n~ sex+age+supply_year+seifa+urbanization + (1|state/lga), data=.) %&gt;% 
  { . } -&gt; model</code></pre>
<pre><code>Joining, by = &quot;pin&quot;</code></pre>
<pre><code>Joining, by = &quot;lga&quot;</code></pre>
<pre><code>Warning: Column `lga` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning in glmer(n ~ sex + age + supply_year + seifa + urbanization + (1 | : calling glmer() with family=gaussian (identity link) as a shortcut to lmer() is deprecated; please call lmer() directly</code></pre>
<pre class="r"><code>summary(model)</code></pre>
<pre><code>Linear mixed model fit by REML [&#39;lmerMod&#39;]
Formula: n ~ sex + age + supply_year + seifa + urbanization + (1 | state/lga)
   Data: .

REML criterion at convergence: 1769570

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.4059 -0.7112 -0.3329  0.3978  3.0859 

Random effects:
 Groups    Name        Variance  Std.Dev.
 lga:state (Intercept) 0.0078705 0.08872 
 state     (Intercept) 0.0002779 0.01667 
 Residual              1.0400227 1.01982 
Number of obs: 614817, groups:  lga:state, 231; state, 2

Fixed effects:
                    Estimate Std. Error t value
(Intercept)        1.2439110  0.0179464  69.313
sexM              -0.1049378  0.0026203 -40.048
age20-44           0.2501137  0.0075957  32.928
age45-64           0.6056132  0.0076054  79.630
age65+             0.9278921  0.0076057 122.000
supply_year.L      0.0268388  0.0026125  10.273
supply_year.Q     -0.0012260  0.0026026  -0.471
supply_year.C      0.0008228  0.0025933   0.317
seifa.L           -0.1606442  0.0135847 -11.825
seifa.Q           -0.0459195  0.0127020  -3.615
seifa.C           -0.0078327  0.0126930  -0.617
urbanizationUrban -0.0729705  0.0144220  -5.060

Correlation of Fixed Effects:
            (Intr) sexM   a20-44 a45-64 age65+ spp_.L spp_.Q spp_.C seif.L seif.Q seif.C
sexM        -0.073                                                                      
age20-44    -0.383  0.014                                                               
age45-64    -0.384  0.004  0.908                                                        
age65+      -0.386  0.022  0.908  0.908                                                 
supply_yr.L -0.008  0.000  0.012  0.014  0.017                                          
supply_yr.Q  0.001  0.001  0.000 -0.001 -0.001 -0.023                                   
supply_yr.C -0.001  0.000  0.002  0.002  0.002  0.005 -0.016                            
seifa.L      0.184  0.002  0.001  0.003  0.002 -0.001  0.000  0.000                     
seifa.Q      0.048  0.000  0.001  0.000  0.000  0.000  0.001  0.001  0.002              
seifa.C      0.005  0.000 -0.001 -0.001 -0.002  0.000  0.000  0.000  0.001 -0.012       
urbnztnUrbn -0.524  0.002 -0.004 -0.001 -0.001  0.000  0.000  0.001 -0.375 -0.098 -0.017</code></pre>
</div>
<div id="figure-2" class="section level2">
<h2>FIgure 2</h2>
<p>mean doses by # quarters using</p>
<pre class="r"><code>df%&gt;%
  inner_join( df_patient_usage ) %&gt;%
  group_by( usage_category, supply_year ) %&gt;%
  summarise( n_dose = round( mean( n_dose ),1) ) %&gt;% 
  ggplot( aes( x=supply_year, y=n_dose, fill=usage_category  ) )+
  geom_col( position=&#39;dodge&#39;) +
  ylab( &quot;Total quantity (in DDD unit) per prescription&quot; ) + 
  xlab(&#39;&#39;)</code></pre>
<pre><code>Joining, by = &quot;pin&quot;</code></pre>
<p><img src="figure/CreateGraphsMofi.Rmd/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;" /></p>
<details> <summary><em>Expand here to see past versions of unnamed-chunk-12-1.png:</em></summary>
<table style="border-collapse:separate; border-spacing:5px;">
<thead>
<tr>
<th style="text-align:left;">
Version
</th>
<th style="text-align:left;">
Author
</th>
<th style="text-align:left;">
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<a href="https://github.com/dewoller/wf_continuing/blob/3fa514905e18267596f20255d846e063b7082424/docs/figure/CreateGraphsMofi.Rmd/unnamed-chunk-12-1.png" target="_blank">3fa5149</a>
</td>
<td style="text-align:left;">
Dennis Wollersheim
</td>
<td style="text-align:left;">
2018-10-08
</td>
</tr>
</tbody>
</table>
<p></details></p>
</div>
<div id="table-1" class="section level2">
<h2>Table 1</h2>
<p>ddd / year (standardised) for each year by user_type</p>
<pre class="r"><code>df %&gt;%
  inner_join( df_patient_usage ) %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;state usage_category supply_year&#39;) , join_with=qw(&#39;supply_year&#39;) ) %&gt;%
  mutate( ddd = round(ddd, 2 ), u_s = paste( usage_category, state)) %&gt;% 
  select(-state, -usage_category) %&gt;%
  group_by( u_s, supply_year ) %&gt;%
  summarise( ddd=sum(ddd))  %&gt;%
  spread( u_s, ddd)  %&gt;% 
  kable()</code></pre>
<pre><code>Joining, by = &quot;pin&quot;</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining character vector and factor, coercing into character vector

Warning: Column `supply_year` joining character vector and factor, coercing into character vector</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
supply_year
</th>
<th style="text-align:right;">
chronic NSW
</th>
<th style="text-align:right;">
chronic VIC
</th>
<th style="text-align:right;">
long-episodic NSW
</th>
<th style="text-align:right;">
long-episodic VIC
</th>
<th style="text-align:right;">
medium-episodic NSW
</th>
<th style="text-align:right;">
medium-episodic VIC
</th>
<th style="text-align:right;">
one-off NSW
</th>
<th style="text-align:right;">
one-off VIC
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2013
</td>
<td style="text-align:right;">
9.55
</td>
<td style="text-align:right;">
9.84
</td>
<td style="text-align:right;">
2.19
</td>
<td style="text-align:right;">
2.12
</td>
<td style="text-align:right;">
2.75
</td>
<td style="text-align:right;">
2.67
</td>
<td style="text-align:right;">
0.64
</td>
<td style="text-align:right;">
0.66
</td>
</tr>
<tr>
<td style="text-align:left;">
2014
</td>
<td style="text-align:right;">
10.30
</td>
<td style="text-align:right;">
10.39
</td>
<td style="text-align:right;">
2.42
</td>
<td style="text-align:right;">
2.26
</td>
<td style="text-align:right;">
1.97
</td>
<td style="text-align:right;">
1.99
</td>
<td style="text-align:right;">
0.55
</td>
<td style="text-align:right;">
0.55
</td>
</tr>
<tr>
<td style="text-align:left;">
2015
</td>
<td style="text-align:right;">
10.40
</td>
<td style="text-align:right;">
10.38
</td>
<td style="text-align:right;">
2.26
</td>
<td style="text-align:right;">
2.21
</td>
<td style="text-align:right;">
1.84
</td>
<td style="text-align:right;">
1.85
</td>
<td style="text-align:right;">
0.55
</td>
<td style="text-align:right;">
0.55
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:right;">
9.47
</td>
<td style="text-align:right;">
9.46
</td>
<td style="text-align:right;">
2.09
</td>
<td style="text-align:right;">
2.00
</td>
<td style="text-align:right;">
2.15
</td>
<td style="text-align:right;">
2.25
</td>
<td style="text-align:right;">
0.60
</td>
<td style="text-align:right;">
0.59
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>df %&gt;%
  inner_join( df_patient_usage ) %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;state usage_category&#39;) , join_with=qw(&#39;supply_year&#39;) ) %&gt;%
  mutate( ddd = round(ddd, 2 ), u_s = paste( usage_category, state)) %&gt;% 
  select(-state, -usage_category) %&gt;%
  group_by( u_s ) %&gt;%
  summarise( ddd=sum(ddd))  %&gt;%
  spread( u_s, ddd)  %&gt;% 
  kable()</code></pre>
<pre><code>Joining, by = &quot;pin&quot;</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining character vector and factor, coercing into character vector

Warning: Column `supply_year` joining character vector and factor, coercing into character vector</code></pre>
<table>
<thead>
<tr>
<th style="text-align:right;">
chronic NSW
</th>
<th style="text-align:right;">
chronic VIC
</th>
<th style="text-align:right;">
long-episodic NSW
</th>
<th style="text-align:right;">
long-episodic VIC
</th>
<th style="text-align:right;">
medium-episodic NSW
</th>
<th style="text-align:right;">
medium-episodic VIC
</th>
<th style="text-align:right;">
one-off NSW
</th>
<th style="text-align:right;">
one-off VIC
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
39.72
</td>
<td style="text-align:right;">
40.07
</td>
<td style="text-align:right;">
8.96
</td>
<td style="text-align:right;">
8.59
</td>
<td style="text-align:right;">
8.71
</td>
<td style="text-align:right;">
8.76
</td>
<td style="text-align:right;">
2.34
</td>
<td style="text-align:right;">
2.35
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>df %&gt;%
  inner_join( df_patient_usage ) %&gt;%
  select_and_standardise_ddd (  standardise_over=qw(&#39;state&#39;) , join_with=qw(&#39;supply_year&#39;) ) %&gt;%
  mutate( ddd = round(ddd, 2 )) %&gt;% 
  spread( state, ddd)  %&gt;% 
  kable()</code></pre>
<pre><code>Joining, by = &quot;pin&quot;</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining factors with different levels, coercing to character vector</code></pre>
<pre><code>Warning: Column `sex` joining character vector and factor, coercing into character vector</code></pre>
<pre><code>Warning: Column `supply_year` joining character vector and factor, coercing into character vector

Warning: Column `supply_year` joining character vector and factor, coercing into character vector</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
supply_year
</th>
<th style="text-align:right;">
NSW
</th>
<th style="text-align:right;">
VIC
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2013
</td>
<td style="text-align:right;">
15.13
</td>
<td style="text-align:right;">
15.30
</td>
</tr>
<tr>
<td style="text-align:left;">
2014
</td>
<td style="text-align:right;">
15.24
</td>
<td style="text-align:right;">
15.19
</td>
</tr>
<tr>
<td style="text-align:left;">
2015
</td>
<td style="text-align:right;">
15.05
</td>
<td style="text-align:right;">
14.99
</td>
</tr>
<tr>
<td style="text-align:left;">
2016
</td>
<td style="text-align:right;">
14.31
</td>
<td style="text-align:right;">
14.29
</td>
</tr>
</tbody>
</table>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.4.4 (2018-03-15)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 17.10

Matrix products: default
BLAS: /usr/lib/x86_64-linux-gnu/openblas/libblas.so.3
LAPACK: /usr/lib/x86_64-linux-gnu/libopenblasp-r0.2.20.so

locale:
 [1] LC_CTYPE=en_AU.UTF-8       LC_NUMERIC=C               LC_TIME=en_AU.UTF-8        LC_COLLATE=en_AU.UTF-8     LC_MONETARY=en_AU.UTF-8    LC_MESSAGES=en_AU.UTF-8    LC_PAPER=en_AU.UTF-8      
 [8] LC_NAME=C                  LC_ADDRESS=C               LC_TELEPHONE=C             LC_MEASUREMENT=en_AU.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] lme4_1.1-17       Matrix_1.2-14     haven_1.1.2       rcompanion_2.0.0  sf_0.6-3          jsonlite_1.5      bindrcpp_0.2.2    sp_1.3-1          keyring_1.1.0     RPostgreSQL_0.6-2
[11] DBI_1.0.0         forcats_0.3.0     dplyr_0.7.6       purrr_0.2.5       readr_1.1.1       tidyr_0.8.1       tibble_1.4.2      ggplot2_2.2.1     tidyverse_1.2.1   shiny_1.1.0      
[21] DataCache_0.9     ordinal_2018.4-19 foreign_0.8-70    readstata13_0.9.2 tmaptools_2.0     tmap_2.0          lubridate_1.7.4   pander_0.6.2      kableExtra_0.9.0  knitr_1.20       
[31] broom_0.5.0       stringr_1.3.1     magrittr_1.5      seas_0.5-2        MASS_7.3-50       data.table_1.11.4 wrapr_1.5.1       nvimcom_0.9-75   

loaded via a namespace (and not attached):
  [1] readxl_1.1.0       backports_1.1.2    workflowr_1.1.1    BSDA_1.2.0         lwgeom_0.1-4       plyr_1.8.4         lazyeval_0.2.1     splines_3.4.4      crosstalk_1.0.0    leaflet_2.0.1     
 [11] TH.data_1.0-9      digest_0.6.15      foreach_1.4.4      htmltools_0.3.6    fansi_0.2.3        modelr_0.1.2       R.utils_2.6.0      sandwich_2.4-0     colorspace_1.3-2   rvest_0.3.2       
 [21] rgdal_1.3-3        crayon_1.3.4       bindr_0.1.1        survival_2.42-3    zoo_1.8-3          iterators_1.0.10   glue_1.3.0         gtable_0.2.0       webshot_0.5.0      scales_0.5.0      
 [31] mvtnorm_1.0-8      Rcpp_0.12.18       viridisLite_0.3.0  xtable_1.8-2       spData_0.2.9.0     units_0.6-0        stats4_3.4.4       htmlwidgets_1.2    httr_1.3.1         RColorBrewer_1.1-2
 [41] modeltools_0.2-22  pkgconfig_2.0.1    XML_3.98-1.12      R.methodsS3_1.7.1  manipulate_1.0.1   multcompView_0.1-7 utf8_1.1.4         tidyselect_0.2.4   labeling_0.3       rlang_0.2.2       
 [51] later_0.7.3        munsell_0.5.0      cellranger_1.1.0   tools_3.4.4        cli_1.0.0          evaluate_0.10.1    EMT_1.1            yaml_2.1.19        satellite_1.0.1    coin_1.2-2        
 [61] nlme_3.1-137       whisker_0.3-2      mime_0.5           R.oo_1.22.0        xml2_1.2.0         compiler_3.4.4     rstudioapi_0.7     curl_3.2           png_0.1-7          e1071_1.6-8       
 [71] DescTools_0.99.25  stringi_1.2.3      highr_0.7          rgeos_0.3-28       lattice_0.20-35    nloptr_1.0.4       classInt_0.2-3     pillar_1.3.0       lmtest_0.9-36      ucminf_1.1-4      
 [81] raster_2.6-7       mapview_2.4.0      httpuv_1.4.5       R6_2.2.2           promises_1.0.1     KernSmooth_2.23-15 codetools_0.2-15   gdalUtils_2.0.1.14 dichromat_2.0-0    boot_1.3-20       
 [91] assertthat_0.2.0   rprojroot_1.3-2    nortest_1.0-4      multcomp_1.4-8     expm_0.999-2       parallel_3.4.4     hms_0.4.2          minqa_1.2.4        class_7.3-14       rmarkdown_1.10    
[101] git2r_0.23.0       base64enc_0.1-3   </code></pre>
</div>
</div>

<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>

<hr>
<p>
  This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a>
  analysis was created with
  <a href="https://github.com/jdblischak/workflowr">workflowr</a> 1.1.1
</p>
<hr>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
